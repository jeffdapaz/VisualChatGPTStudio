<UserControl x:Class="JeffPires.VisualChatGPTStudio.ToolWindows.Turbo.TerminalWindowTurboControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vsshell="clr-namespace:Microsoft.VisualStudio.Shell;assembly=Microsoft.VisualStudio.Shell.15.0"
             xmlns:imaging="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.Imaging"
             xmlns:catalog="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.ImageCatalog"
             xmlns:utils="clr-namespace:JeffPires.VisualChatGPTStudio.Utils"
             xmlns:vm="clr-namespace:VisualChatGPTStudioShared.ToolWindows.Turbo"
             Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"
             Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="400">

    <UserControl.Resources>
        <RoutedUICommand x:Key="cancelCommand" Text="Text" />
        <RoutedUICommand x:Key="sendCode" Text="Text" />
        <vm:TerminalTurboViewModel x:Key="Vm"/>
        <utils:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <utils:NullableToVisibilityConverter x:Key="NullToVis" />
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="IsTabStop" Value="True"/>
            <Setter Property="Focusable" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Control.Background}"
                                BorderThickness="{TemplateBinding Control.BorderThickness}"
                                BorderBrush="{TemplateBinding Control.BorderBrush}"
                                Padding="8" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}" Property="Control.BorderBrush"/>
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedKey}}" Property="Control.Background"/>
                            </Trigger>
                            <Trigger Property="UIElement.IsMouseOver" Value="true">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverKey}}" Property="Control.Background"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="IsTabStop" Value="True"/>
            <Setter Property="Focusable" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Control.Background}"
                                BorderThickness="{TemplateBinding Control.BorderThickness}"
                                BorderBrush="{TemplateBinding Control.BorderBrush}"
                                Padding="8" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}" Property="Control.BorderBrush"/>
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedKey}}" Property="Control.Background"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="true">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverKey}}" Property="Control.Background"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}" Property="Control.Background"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ToolbarButtonStyle" TargetType="{x:Type Button}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border x:Name="border" Background="{TemplateBinding Control.Background}"
                                BorderThickness="{TemplateBinding Control.BorderThickness}"
                                Padding="{TemplateBinding Control.Padding}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="UIElement.IsFocused" Value="true">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}" Property="Control.Background"/>
                            </Trigger>
                            <Trigger Property="UIElement.IsMouseOver" Value="true">
                                <Setter Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverKey}}" Property="Control.Background"/>
                            </Trigger>
                            <Trigger Property="UIElement.IsEnabled" Value="False">
                                <Setter Value="0.5" Property="Control.Opacity"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SlideBarStyle" TargetType="{x:Type Border}">
            <Style.Triggers>
                <Trigger Property="UIElement.Visibility" Value="Visible">
                    <TriggerBase.EnterActions>
                        <BeginStoryboard>
                            <Storyboard>
                                <ThicknessAnimation Storyboard.TargetProperty="Margin" From="360,0,-360,0" To="0" Duration="0:0:0.2">
                                    <ThicknessAnimation.EasingFunction>
                                        <CubicEase EasingMode="EaseOut"/>
                                    </ThicknessAnimation.EasingFunction>
                                </ThicknessAnimation>
                            </Storyboard>
                        </BeginStoryboard>
                    </TriggerBase.EnterActions>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Storyboard x:Key="FadeIn">
            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
        </Storyboard>
    </UserControl.Resources>

    <UserControl.CommandBindings>
        <CommandBinding Command="{StaticResource cancelCommand}" Executed="CancelRequest" />
        <CommandBinding Command="{StaticResource sendCode}" Executed="SendCode" />
    </UserControl.CommandBindings>

    <UserControl.InputBindings>
        <KeyBinding Key="Q" Modifiers="Alt" Command="{StaticResource cancelCommand}" />
        <KeyBinding Key="Enter" Modifiers="Ctrl+Alt" Command="{StaticResource sendCode}" />
        <KeyBinding Key="Enter" Modifiers="Ctrl+Alt+Shift" Command="{StaticResource sendCode}" />
    </UserControl.InputBindings>

    <UserControl.DataContext>
        <StaticResource ResourceKey="Vm"/>
    </UserControl.DataContext>

    <Grid Margin="5">
        <Grid.Triggers>
            <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                <BeginStoryboard Storyboard="{StaticResource FadeIn}"/>
            </EventTrigger>
        </Grid.Triggers>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" MinHeight="40"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto" x:Name="rowRequest" />
        </Grid.RowDefinitions>
        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarGradientKey}}"
    BorderThickness="0,0,0,1"
    BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarBorderKey}}" Padding="8,4">
            <StackPanel Orientation="Horizontal">
                <Button Click="NewChat_Click"
                        Style="{StaticResource ToolbarButtonStyle}"
                        ToolTip="New Chat" Focusable="True"
                        TabIndex="101"
                        IsTabStop="True"
                        IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <imaging:CrispImage Width="16" Height="16" Margin="0,0,4,0"
                            Moniker="{x:Static catalog:KnownMonikers.AddDocument}"
                            Opacity="1"/>
                            <TextBlock Text="New Chat" VerticalAlignment="Center"/>
                        </StackPanel>
                </Button>
                <Button Click="DeleteChat_Click"
                        Style="{StaticResource ToolbarButtonStyle}"
                        ToolTip="Delete Chat"
                        TabIndex="102"
                        IsTabStop="True"
                        IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.DeleteEntity}" Width="16"
                            Height="16" Margin="0,0,4,0"
                            Opacity="1"/>
                            <TextBlock Text="Delete Chat" VerticalAlignment="Center"/>
                        </StackPanel>
                </Button>
                <Button Click="ToggleHistory_Click"
                        Style="{StaticResource ToolbarButtonStyle}"
                        ToolTip="Chat History"
                        TabIndex="103"
                        IsTabStop="True"
                        IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.History}" Width="16"
                            Height="16" Margin="0,0,4,0"
                            Opacity="1"/>
                            <TextBlock Text="History" VerticalAlignment="Center"/>
                        </StackPanel>
                </Button>
                <Button Click="ToggleSettings_Click"
                        Style="{StaticResource ToolbarButtonStyle}"
                        ToolTip="Settings"
                        TabIndex="104"
                        IsTabStop="True"
                        Visibility="Collapsed"
                        IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Settings}" Width="16"
                            Height="16" Margin="0,0,4,0"
                            Opacity="1"/>
                            <TextBlock Text="Settings" VerticalAlignment="Center"/>
                        </StackPanel>
                </Button>
            </StackPanel>
        </Border>
        <!-- Chat -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" MinHeight="100"/>
                <RowDefinition Height="15"/>
                <RowDefinition Height="Auto" MaxHeight="600"/>
                <RowDefinition Height="5"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- WebView -->
            <ContentPresenter x:Name="WebViewHost" />

            <Grid Grid.Row="4"
                  Visibility="{Binding IsRequestInProgress, Converter={StaticResource BoolToVis}}">
                <ProgressBar Minimum="0" Maximum="100" IsIndeterminate="True" />
                <TextBlock
                    Text="{Binding ProgressStatus}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Foreground="Black" />
            </Grid>
        </Grid>
        <!-- Request textbox area -->
        <Grid Grid.Row="2"
              Margin="8,4,8,8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="5"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="5"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <StackPanel Grid.Row="0" Orientation="Vertical">
                <StackPanel
                    Orientation="Horizontal"
                    Visibility="{Binding AttachedImageText, Converter={StaticResource NullToVis}}">
                    <TextBlock
                        Text="{Binding AttachedImageText, Mode=TwoWay}"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Height="20"
                        Margin="0,0,10,0"
                        Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}" />
                    <Button
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Click="btnDeleteImage_Click">
                        <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Cancel}" />
                    </Button>
                </StackPanel>
                <ComboBox
                    SelectedIndex="{Binding SqlServerConnectionSelectedIndex}"
                    ItemsSource="{Binding SqlServerConnections}"
                    Visibility="{Binding UseSqlTools, Converter={StaticResource BoolToVis}}"
                    DisplayMemberPath="Description"
                    SelectedValuePath="ConnectionString" />
                <ComboBox
                    SelectedIndex="{Binding ApiDefinitionSelectedIndex}"
                    ItemsSource="{Binding ApiDefinitions}"
                    Visibility="{Binding UseApiTools, Converter={StaticResource BoolToVis}}"
                    DisplayMemberPath="Name"
                    SelectedValuePath="Name" />
            </StackPanel>
            <!-- Request textBox -->
            <Border Grid.Row="2"
                    CornerRadius="4"
                    BorderBrush="LightGray"
                    BorderThickness="1"
                    Padding="4"
                    MaxHeight="200"
                    Background="{DynamicResource {x:Static vsshell:VsBrushes.WindowKey}}">
                <avalonEdit:TextEditor
                    xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit"
                    Name="txtRequest"
                    Document="{Binding RequestDoc}"
                    FontSize="16"
                    HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto"
                    ShowLineNumbers="false"
                    TabIndex="1"
                    IsTabStop="True"
                    Focusable="True"
                    Background="Transparent"
                    Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}">
                    <avalonEdit:TextEditor.ContextMenu>
                        <ContextMenu>
                            <MenuItem Command="Paste" />
                        </ContextMenu>
                    </avalonEdit:TextEditor.ContextMenu>
                </avalonEdit:TextEditor>
            </Border>
            <!-- Request commands -->
            <StackPanel Name="grdCommands"
                        Grid.Row="4"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right" >
                <StackPanel.Resources>
                    <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
                        <Setter Property="Margin" Value="8,0"/>
                    </Style>
                    <Style TargetType="{x:Type ToggleButton}" BasedOn="{StaticResource {x:Type ToggleButton}}">
                        <Setter Property="Margin" Value="8,0"/>
                    </Style>
                </StackPanel.Resources>
                <ToggleButton
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Add context to a database"
                    AutomationProperties.HelpText="Add context to a database"
                    TabIndex="2"
                    IsChecked="{Binding UseSqlTools}">
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Database}" />
                </ToggleButton>
                <ToggleButton
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Add context to an API"
                    AutomationProperties.HelpText="Add context to an API"
                    TabIndex="3"
                    IsChecked="{Binding UseApiTools}">
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Cloud}" />
                </ToggleButton>
                <Button
                    IsEnabled="{Binding IsReadyToRequest}"
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Attach an image"
                    AutomationProperties.HelpText="Attach an image"
                    TabIndex="4"
                    Click="btnAttachImage_Click">
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Attach}" />
                </Button>
                <Button
                    IsEnabled="{Binding IsReadyToRequest}"
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Computer-Use: Let the AI take control of Visual Studio to execute your instruction"
                    AutomationProperties.HelpText="Computer-Use: Let the AI take control of Visual Studio to execute your instruction"
                    TabIndex="5"
                    Click="btnComputerUse_Click" >
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Aggregate}" />
                </Button>
                <Button
                    IsEnabled="{Binding IsReadyToRequest}"
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Send Code (Ctrl+Alt+Enter)"
                    AutomationProperties.HelpText="Send Code (Ctrl+Alt+Enter)"
                    TabIndex="6"
                    Click="SendCode" >
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Code}" />
                </Button>
                <Button
                    IsEnabled="{Binding IsReadyToRequest}"
                    Visibility="{Binding IsReadyToRequest, Converter={StaticResource BoolToVis}}"
                    ToolTip="Send (Ctrl+Enter)"
                    AutomationProperties.HelpText="Send (Ctrl+Enter)"
                    TabIndex="7"
                    Click="SendRequest" >
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Send}" />
                </Button>
                <Button
                    IsEnabled="{Binding IsRequestInProgress}"
                    Visibility="{Binding IsRequestInProgress, Converter={StaticResource BoolToVis}}"
                    ToolTip="Cancel (Alt+Q)"
                    AutomationProperties.HelpText="Cancel (Alt+Q)"
                    Click="CancelRequest"
                    TabIndex="8" >
                    <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Cancel}" />
                </Button>
            </StackPanel>
        </Grid>
        <!-- Sidebars -->
        <Border x:Name="Overlay" Grid.RowSpan="3"
                Focusable="False"
                Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}" Opacity="0.5"
                MouseDown="Overlay_OnMouseDown"
                Visibility="Collapsed">
            <FrameworkElement.Style>
                <Style TargetType="{x:Type Border}">
                    <Style.Triggers>
                        <Trigger Property="UIElement.Visibility" Value="Visible">
                            <TriggerBase.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="0.5" Duration="0:0:0.2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </TriggerBase.EnterActions>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </FrameworkElement.Style>
        </Border>
        <Border x:Name="HistorySidebar"
                Grid.RowSpan="3"
                Style="{StaticResource SlideBarStyle}"
                FocusManager.IsFocusScope="True"
                KeyboardNavigation.TabNavigation="Cycle"
                KeyboardNavigation.DirectionalNavigation="Contained"
                KeyboardNavigation.TabIndex="0"
                Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"
                BorderThickness="1,0,0,0"
                BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}"
                Width="360"
                HorizontalAlignment="Right"
                Visibility="Collapsed">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <!-- history header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowTabGradientKey}}"
                        BorderThickness="0,0,0,1"
                        BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}">
                    <Grid Margin="16,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <TextBlock Text="Chat History" FontSize="16" FontWeight="SemiBold"
                     Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"/>
                            <TextBlock Text="Your previous conversations" Margin="0,4,0,0"
                     Foreground="{DynamicResource {x:Static vsshell:VsBrushes.GrayTextKey}}" />
                        </StackPanel>
                        <Button Click="CloseHistoryButton_Click" Grid.Column="1" Style="{StaticResource ToolbarButtonStyle}"
                Width="28" Height="28" Padding="6" VerticalAlignment="Top">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Close}" UIElement.Opacity="0.9"/>
                        </Button>
                    </Grid>
                </Border>
                <!-- history search -->
                <Border Grid.Row="1" Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}" Padding="16,12">
                    <Grid>
                        <TextBox x:Name="HistorySearch"
                                 PreviewKeyDown="HistorySearch_PreviewKeyDown"
                                 Text="{Binding Search, UpdateSourceTrigger=PropertyChanged}" Height="32">
                            <FrameworkElement.Style>
                                <Style TargetType="{x:Type TextBox}">
                                    <Setter Property="Background"
                                            Value="{DynamicResource {x:Static vsshell:VsBrushes.SearchBoxBackgroundKey}}"/>
                                    <Setter Property="Foreground" Value="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"/>
                                    <Setter Property="BorderBrush"
                                            Value="{DynamicResource {x:Static vsshell:VsBrushes.SearchBoxBorderKey}}"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="{x:Type TextBox}">
                                                <Border Background="{TemplateBinding Control.Background}"
                                                        BorderBrush="{TemplateBinding Control.BorderBrush}" BorderThickness="1" CornerRadius="4">
                                                    <Grid>
                                                        <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Search}"
                                                                            Width="16"
                                                                            Height="16"
                                                                            HorizontalAlignment="Left"
                                                                            Margin="8,0,0,0"
                                                                            Opacity="0.6"/>
                                                        <ScrollViewer x:Name="PART_ContentHost" Margin="32,6,8,6" VerticalAlignment="Center"/>
                                                    </Grid>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </FrameworkElement.Style>
                        </TextBox>
                    </Grid>
                </Border>
                <!-- history list -->
                <ListBox Grid.Row="2"
                         x:Name="HistoryListBox"
                         SelectionChanged="HistoryList_SelectionChanged"
                         MouseDoubleClick="HistoryList_MouseDoubleClick"
                         PreviewKeyDown="HistoryList_PreviewKeyDown"
                         ItemsSource="{Binding Chats}"
                         Background="Transparent" BorderThickness="0" Margin="0" Padding="16,8"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled" VirtualizingPanel.IsVirtualizing="true"
                         VirtualizingPanel.VirtualizationMode="Recycling">
                    <!-- history item -->
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="{x:Type ListBoxItem}">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="12, 8"/>
                            <Setter Property="Margin" Value="2,4"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Focusable" Value="True" />
                            <EventSetter Event="PreviewKeyDown" Handler="HistoryListItem_PreviewKeyDown"/>
                            <Setter Property="LayoutTransform">
                                <Setter.Value>
                                    <ScaleTransform x:Name="transform" />
                                </Setter.Value>
                            </Setter>
                            <!-- history item style -->
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="border"
                                                Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowTabMouseOverBackgroundBeginKey}}"
                                                BorderBrush="Transparent"
                                                BorderThickness="2"
                                                CornerRadius="4"
                                                Margin="2"
                                                Padding="0, 8, 12,8"
                                                SnapsToDevicePixels="true">
                                            <ContentPresenter />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="border" Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverKey}}"/>
                                            </Trigger>

                                            <!-- selected item -->
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="border" Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedKey}}"/>
                                            </Trigger>

                                            <!-- focused item (keyboard UP / DOWN) -->
                                            <Trigger Property="IsKeyboardFocusWithin" Value="True">
                                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}"/>
                                            </Trigger>

                                            <!-- selected & focused -->
                                            <MultiTrigger>
                                                <MultiTrigger.Conditions>
                                                    <Condition Property="IsSelected" Value="True"/>
                                                    <Condition Property="IsKeyboardFocusWithin" Value="True"/>
                                                </MultiTrigger.Conditions>
                                                <MultiTrigger.Setters>
                                                    <Setter TargetName="border" Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverOverSelectedKey}}"/>
                                                </MultiTrigger.Setters>
                                            </MultiTrigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Effect" Value="{x:Null}" />
                            <Style.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <EventTrigger.Actions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" Duration="0:0:.2" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger.Actions>
                                </EventTrigger>
                                <Trigger Property="IsKeyboardFocused" Value="True">
                                    <Setter Property="Effect">
                                        <Setter.Value>
                                            <DropShadowEffect Color="RoyalBlue" ShadowDepth="0" BlurRadius="10" />
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="SelectedBorder"
                                        Grid.Column="0"
                                        Width="4"
                                        Margin="0, 0, 8, 0"
                                        Background="Transparent"
                                        />
                                <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                    <TextBlock x:Name="txt"
                                               TextTrimming="CharacterEllipsis"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                                               Text="{Binding Name}"/>
                                    <TextBox x:Name="box"
                                             FontWeight="SemiBold"
                                             FontSize="14"
                                             Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                             Visibility="Collapsed"
                                             IsManipulationEnabled="False"
                                             IsVisibleChanged="Box_OnIsVisibleChanged">
                                    </TextBox>
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Calendar}" Width="12"
                                                          Height="12" Margin="0,0,4,0" Opacity="0.7"/>
                                        <TextBlock Foreground="{DynamicResource {x:Static vsshell:VsBrushes.GrayTextKey}}" FontSize="11"
                                                 VerticalAlignment="Center"
                                                 Text="{Binding Date,TargetNullValue='â€“',StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"/>
                                    </StackPanel>
                                </StackPanel>
                                <!-- History buttons -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal" >
                                    <Button ToolTip="Rename chat history"
                                            VerticalAlignment="Center"
                                            Command="{Binding DataContext.StartRenameCmd, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}">
                                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Rename}" />
                                    </Button>
                                    <Button ToolTip="Delete chat history"
                                            VerticalAlignment="Center"
                                            Command="{Binding DataContext.DeleteCmd, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}" >
                                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Cancel}" />
                                    </Button>
                                </StackPanel>
                            </Grid>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                    <Setter TargetName="txt" Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="box" Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                    <Setter TargetName="SelectedBorder" Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.HighlightKey}}" />
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ListBox>
                <!-- history paging -->
                <Border Grid.Row="3"
                        Background="Transparent"
                        BorderThickness="0,1,0,0"
                        BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}">
                    <Grid Margin="16,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Button Command="{Binding PrevCmd}"
                                IsEnabledChanged="HistoryPagingButton_OnIsEnabledChanged"
                                Style="{StaticResource ToolbarButtonStyle}"
                                Width="28"
                                Height="28"
                                Padding="6">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Previous}" Opacity="0.9"/>
                        </Button>
                        <TextBlock Text="{Binding CurrentPageView}" Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                   Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"/>
                        <Button Command="{Binding NextCmd}"
                                IsEnabledChanged="HistoryPagingButton_OnIsEnabledChanged"
                                Grid.Column="2"
                                Style="{StaticResource ToolbarButtonStyle}"
                                Width="28"
                                Height="28"
                                Padding="6">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Next}" Opacity="0.9"/>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </Border>
        <Border x:Name="SettingsSidebar" Grid.RowSpan="3" Style="{StaticResource SlideBarStyle}"
                Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"
                BorderThickness="1,0,0,0"
                BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}" Width="360"
                HorizontalAlignment="Right" Visibility="Collapsed">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowTabGradientKey}}"
            BorderThickness="0,0,0,1"
            BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}">
                    <Grid Margin="16,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <TextBlock Text="Settings" FontSize="16" FontWeight="SemiBold"
                     Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"/>
                            <TextBlock Text="Basic model settings" Margin="0,4,0,0"
                     Foreground="{DynamicResource {x:Static vsshell:VsBrushes.GrayTextKey}}" />
                        </StackPanel>
                        <Button Click="CloseSettingsButton_Click" Grid.Column="1" Style="{StaticResource ToolbarButtonStyle}"
                Width="28" Height="28" Padding="6" VerticalAlignment="Top">
                            <imaging:CrispImage Moniker="{x:Static catalog:KnownMonikers.Close}" Opacity="0.9"/>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
